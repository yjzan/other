/* global twentyseventeenScreenReaderText */
(function( $ ) {

    /*begin 001购买数量初始化组件---------------------------------------------------------------------------*/

    var ready_set_cart;
    quantity();
    function quantity() {
        $(".yjz_cart_layer .modify-qty ,.pc_yjz_cart_layer .modify-qty").unbind();
        $(".yjz_cart_layer .modify-qty ,.pc_yjz_cart_layer .modify-qty").on('click',function(){
            var  _input = $(this).parent().find('input'),
                currVal = parseInt(_input.val(), 10),
                max = parseInt(_input.prop('max'));

            if ('minus' === $(this).attr('data-click') && currVal > 1) {
                _input.val(currVal - 1);
            }

            if ('plus' === $(this).attr('data-click')) {
                if (currVal >= max) return;
                _input.val(currVal + 1);
            }
        });

        $(".woocommerce-mini-cart  .quantity").each(function () {
            var quantitydiv =  $(this);
            quantitydiv.find('.modify-qty').on('click',function(){
                $(".woocommerce-mini-cart ").attr('time_click',(new Date()).valueOf());
                var  _input = $(quantitydiv).find('input'),
                    currVal = parseInt(_input.val(), 10),
                    max = parseInt(_input.prop('max'));

                if ('minus' === $(this).attr('data-click') && currVal >= 1) {
                    currVal= currVal - 1;
                }

                if ('plus' === $(this).attr('data-click')) {
                    if (currVal >= max) return;
                    currVal= currVal + 1;
                }

                if(currVal>0)
                    _input.val(currVal);

                setCartItemQuantity(quantitydiv,currVal,true);
                // $("[name='update_cart']"").prop('disabled', false);
            });
        });

    };

    function setCartItemQuantity(obj,item_num,checkTime = false) {
        if(checkTime===true  )
        {
            var time_click = parseInt($(".woocommerce-mini-cart ").attr('time_click'));
            var nowtime = (new Date()).valueOf();
            if((nowtime - time_click ) <=500){
                window.clearTimeout(ready_set_cart);
                ready_set_cart = setTimeout(function(){ setCartItemQuantity(obj,item_num,true) },500);
                return false;
            }
        }

        if(item_num==0){
            if(!confirm('确认删除该所选商品?')){
                return false;
            }
        }

        ready_set_cart=0;
        var item_key = $(obj).attr('data-cart-key');
        var variation_id= $(obj).attr('data-variation-id');
        var product_id= $(obj).attr('data-product-id');
        var iteem_price = $(obj).attr('data-cart-price');
        if($(obj).hasClass('remove-cart-item')){
            $(obj).find("i").addClass('addcartloading').addClass('fa-spin');
        }

        yjzWinInfo('正在更新购物车','loading',false);
        $.post(site_url+ "/wp-admin/admin-ajax.php",
            "action=set_cart_quantity&product_id="+product_id+"&quantity="+item_num+"&variation_id="+variation_id+"&cart_item_key="+item_key
        ).done(function( data ) {
            if (data.status==1) {
                if(item_num==0)
                    $(obj).parent().parent().remove();
                //修改金额总数
                var amount = $('#yjz_cart_subtotal .woocommerce-Price-amount').html();
                amount = amount.split('</span>');
                $('#yjz_cart_subtotal .woocommerce-Price-amount').html(amount[0]+'</span>'+data.subtotal);
                $('.yjzan-button-icon').attr('data-counter',data.item_quantity);
                if(data.item_quantity==0){
                    $('#yjz_cart_subtotal').hide();
                    $('.shopinfo').hide();
                    $(".woocommerce-mini-cart__empty-message").show();
                    $(".yjzan-menu-cart__footer-buttons").hide();
                    $(".woocommerce-mini-cart.woocommerce-cart-form__contents").html('');

                }else
                {
                    $(".yjzan-menu-cart__footer-buttons").show();
                    $('.shopinfo').show();
                }
                $("#yjz-loading-icon1").fadeOut(500);
            }else
            {
                $(obj).find("i").removeClass('addcartloading').removeClass('fa-spin');
                yjzWinInfo("操作失败","iconfont icon-close");
            }
            ready_set_cart =0;
        });
    }


    $('.yjz-yd-header-licon').on('click', function (){
        javascript:history.go(-1);
    });

    $(".yjz_cart_mask_layer,.yjz_cart_close_btn").on("click",function(){
        hide_cart_layer();
    });

    $(".clear-cart").click(function(e){

        if(!confirm('确认清空购物车?')){
            return false;
        }

        yjzWinInfo('正在更新购物车','loading',false);
        $.post(site_url+ "/wp-admin/admin-ajax.php",
            "action=set_cart_quantity&clearall=1"
        ).done(function( data ) {
            if (data.status==1) {
                $('#yjz_cart_subtotal').hide();
                $('.shopinfo').hide();
                $(".woocommerce-mini-cart__empty-message").show();
                $(".yjzan-menu-cart__footer-buttons").hide();
                $(".woocommerce-mini-cart.woocommerce-cart-form__contents").html('');
                $("#yjz-loading-icon1").fadeOut(500);
            }else
            {
                yjzWinInfo("操作失败","iconfont icon-close");
            }
        });

    });

    /*end 001购买数量初始化组件---------------------------------------------------------------------------*/


    //begin 002加入购物车--------------------------------------------------------------------------------------------------------------------
   setTimeout(function () {
       $(".add_to_cart_button").on("click", function (event) {
           event.stopPropagation();
           if($(this).hasClass("disabled"))
           {
               yjzWinInfo('该产品已售空','text');
               return ;
           }
           $(this).addClass('finish');
           return product_add_to_cart(this);
       });
   },500);


    if( $("#yjzp_current_page").length>0)
        $("#yjzp_current_page").val(1);

    function product_add_to_cart(obj) {

        $(obj).find(".add-cart-icon").addClass('addcartloading').addClass('fa-spin');

        var p_id = $(obj).attr('data-product_id');
        var issingle = $(obj).hasClass('product_type_simple');
        var p_img = $(obj).attr('data-img');//加载头像
        $('#yjz_cart_p_img').attr('src',p_img);
        $('#yjz_cart_p_img').attr('data-original',p_img);
        $('#cart_p_title').html($(obj).attr('data-title')); //加载标题
        var p_stock = $(obj).attr('data-stock'); //加载库存
        if(p_stock=='有货'||p_stock=='')
            p_stock = '库存有货';
        else if(p_stock <20 && p_stock>0)
            p_stock = '仅剩 <span class="cart_stock_number">'+p_stock+'</span> 件'
        else
            p_stock = '剩余 <span class="cart_stock_number">'+p_stock+'</span> 件'

        $('#cart_p_stock').html(p_stock);


        //初始化
        $(".p_attr_json").attr('data-pinfo','');

         //单规格
        if (issingle)
        {
            $('.cart_p_tip').html('');
            $('#cart_p_item_choose').html(''); //屏蔽规格选项
            var p_is_more_price = 0;
            setTimeout(function () { $(obj).find(".add-cart-icon").removeClass('addcartloading').removeClass('fa-spin');},500);
            load_product_price(obj);
            show_cart_layer();
        }else  //多规格
        {
            var p_is_more_price = $(obj).attr('data-is-more-price');
            //获取产品属性 加载价格
            load_product_attr(p_id,obj);
        }

        //注册加入购物车按钮
        $(".btn_add_cart").unbind();
        $(".btn_checkout").unbind();
        $(".btn_add_cart").on("click", function () {
            yjz_add_to_car(p_id,issingle,false);
        });

        //注册立即购买按钮
        $(".btn_checkout").on("click", function () {
            yjz_add_to_car(p_id,issingle,true);
        });
    }

    function yjz_add_to_car(product_id_val,issingle,ischeckout) {

        var attrid =null;
        var c_param = '';
        var params = {'action':'yjz_add_to_cart','product_id':product_id_val,'quantity':$("#cart_p_qty_num").val(),'variation_id':attrid};
        if(issingle===false)
        {
            var attrobj = get_choose_attr();
            if(attrobj===false)
            {
                yjzWinInfo('请选择产品规格','text');
                return false;
            }
            params['variation_id'] = attrobj.attrid;
            var res = JSON.parse($('.p_attr_json').attr('data-pinfo'));

            for(var key in res.options)
            {
                params['attribute['+key+']'] = attrobj[key];
            }
        }

        hide_cart_layer();
        $.ajax({
            type:"POST",
            url:site_url+ "/wp-admin/admin-ajax.php"+c_param,
            data:params,
            success:function(resp){
                if ( resp && resp.status==1 ) {
                    yjzWinInfo('成功加入购物车');
                    if(ischeckout)
                    {
                        location.href='/cart/';
                    }

                }else
                    yjzWinInfo(data.msg,"iconfont icon-close");
            },
            error:function(xhr,errorText,errorType){
                yjzWinInfo("服务器响应超时","iconfont icon-close");
            },
            complete:function(){
                //do something
            }
        });

    }


    var load_product_attr_loading = 0;
    //加载产品规格选项
    function load_product_attr(p_id,obj)
    {
        if(load_product_attr_loading==1)
            return;
        else
            load_product_attr_loading =1;

        var p_key = p_id+'_product_atrrs';

        // var product_atrrs = sessionStorage.getItem(p_key);
        // if(product_atrrs!='' && product_atrrs != null)
        // {
        //     $(".p_attr_json").attr('data-pinfo',product_atrrs);
        //     var res = JSON.parse(product_atrrs);
        //     load_product_attr_data(res);
        //     load_product_price(obj,res);
        //     show_cart_layer();
        //     if(obj!=null)
        //         setTimeout(function () { $(obj).find(".add-cart-icon").removeClass('addcartloading').removeClass('fa-spin');},500);
        //     load_product_attr_loading = 0;
        //     return;
        // }

        var params = {'action':'get_product_attr','product_id':p_id};
        $.ajax({
            url: "/wp-admin/admin-ajax.php",//传向后台服务器文件
            type: 'POST',    //传递方法
            data: params,  //传递的数据
            dataType : 'json',  //传递数据的格式
            success: function (res){
                if(res.status=='1')
                {
                    sessionStorage.setItem(p_key,JSON.stringify(res));
                    load_product_attr_data(res);
                    load_product_price(obj,res);
                    show_cart_layer();
                }else
                    yjzWinInfo('服务器访问失败','text');

                load_product_attr_loading =0;
                //序列化产品信息
                $(".p_attr_json").attr('data-pinfo',JSON.stringify(res));

                if(obj!=null)
                    $(obj).find(".add-cart-icon").removeClass('addcartloading').removeClass('fa-spin');
            },
            error: function () {
                yjzWinInfo('请求访问失败','text');
                load_product_attr_loading =0;
                if(obj!=null)
                    $(obj).find(".add-cart-icon").removeClass('addcartloading').removeClass('fa-spin');
            },
            complete : function(XMLHttpRequest,status){ //请求完成后最终执行参数
                if(status=='timeout'){//超时,status还有success,error等值的情况
                    load_product_attr_loading =0;
                    if(obj!=null)
                        $(obj).find(".add-cart-icon").removeClass('addcartloading').removeClass('fa-spin');
                }
            }
        }); //end ajax

    }

    //加载产品属性远程数据
    function load_product_attr_data(res)
    {
        var temphtml ='<div class="p_var_group">';
        var i =1;
        var tipcontent = '请选择';

        var img_place_holder = $('#yjz_cart_p_img').attr('data-placeholder');
        for(var key in res.options)
        {
            temphtml +='<div class="p_var_name">'+key+'</div>';
         //   console.log(key + ":"+JSON.stringify(res.options[key]));
            var templatespan = '<span class="yjz_cart_choose_value cart_var_group{0} {4}" data-group="cart_var_group{0}" data-key="{1}" data-value="{2}" data-img="{5}" onclick="yjz_choose_cart_var(this)">{3}<div class="p_attr_name">{2}</div></span>';
            temphtml+='<div class="p_var_label">';
            for(var ckey in res.options[key])
            {
                var cvalue = res.options[key][ckey];
                var imghtml = '';
                var haspic ='';
                var imgurl ='';
                if(typeof res.img_group[cvalue] !='undefined'){
                    imghtml = '<img class="myattrimg" src="'+img_place_holder+'" data-src="'+res.img_group[cvalue]+'">';
                    haspic ='haspic';
                    imgurl = res.img_group[cvalue];
                }
                temphtml +=templatespan.format(i,key,cvalue,imghtml,haspic,imgurl);
            }
            temphtml+='</div>';
            if(i!= res.options_length)
                temphtml+=' <hr/>';


            tipcontent +='  '+key;
            i++;
        }
        temphtml +='</div>';
        $(".cart_p_info .cart_p_tip").html(tipcontent);
        $(".cart_p_info .cart_p_tip").attr('data-content',tipcontent);
        $('#cart_p_item_choose').html(temphtml);
        $('.cart_p_item_choose .myattrimg').each(function(){
            $(this).attr('src',$(this).attr('data-src'));
        });


    }

    //加载价钱
     function load_product_price(obj,res=null)
     {
         var issingle = $(obj).hasClass('product_type_simple');
         var p_currency = $(obj).attr('data-currency'); //加载金额单位
         var p_is_more_price = $(obj).attr('data-is-more-price');
         var pricehtml=''

         if (issingle)
         {
             if($(obj).attr('data-sale-price')!=0&&$(obj).attr('data-is-on-sale')==1)
             {
                 pricehtml = '<span class="price">'+
                     '<span class="p_currency">'+p_currency+'</span>'+  parseFloat($(obj).attr('data-sale-price')).toFixed(2) +
                     '<del>原价 : <span class="p_currency">'+p_currency+'</span>'+ parseFloat($(obj).attr('data-regular-price')).toFixed(2) + '</del>'+
                     '<span class="discount_tag">限时折扣</span>'+
                     '</span>';
             }else
             {
                 pricehtml = '<span class="p_currency">'+p_currency+'</span>';
                 pricehtml += parseFloat($(obj).attr('data-regular-price')).toFixed(2);
             }

         }else  //多规格
         {
             var minprice=0, maxprice=0,max_regular_price=0,all_is_on_sale = true;
              //获取价格范围
             for(var key in res.attrdata) {
                 var item = res.attrdata[key];

                 if (item['is_on_sale'] == 1) {
                     var tempprice = parseFloat(item['_sale_price']).toFixed(2);
                     minprice = minprice < tempprice && minprice!=0  ? minprice : tempprice ;
                     maxprice = maxprice > tempprice && maxprice!=0  ? maxprice : tempprice;
                     max_regular_price =  max_regular_price > parseFloat(item['_regular_price']).toFixed(2)? max_regular_price : parseFloat(item['_regular_price']).toFixed(2);
                 } else
                 {
                     var tempprice = parseFloat(item['_regular_price']).toFixed(2);
                     minprice = minprice < tempprice && minprice!=0  ? minprice : tempprice ;
                     maxprice = maxprice > tempprice && maxprice!=0 ? maxprice : tempprice;
                     all_is_on_sale = false;
                 }
             }

             if(minprice == maxprice)
             {
                 if(all_is_on_sale)
                 {
                     pricehtml = '<span class="price">'+
                         '<span class="p_currency">'+p_currency+'</span>'+ parseFloat(minprice).toFixed(2)+
                         '<del>原价 : <span class="p_currency">'+p_currency+'</span>'+ parseFloat(max_regular_price).toFixed(2)+ '</del>'+
                         '<span class="discount_tag">限时折扣</span>'+
                         '</span>';
                 }else
                 {
                     pricehtml = '<span class="p_currency">'+p_currency+'</span>'+parseFloat(minprice).toFixed(2);
                 }
             }else
             {
                 pricehtml = '<span class="p_currency">'+p_currency+'</span>';
                 pricehtml += parseFloat(minprice).toFixed(2) +' - '+ parseFloat(maxprice).toFixed(2);
             }

             //如果价格，活动，活动计划一致，显示促销价

         }

         $('#cart_p_price').html(pricehtml);
         $('#cart_p_price').attr('data-pricetext',pricehtml);
         $('#cart_p_price').attr('data-currency',p_currency);
     }

     function yjzWinInfo(msg='数据加载中',icon=null,isfadeout=true,lifetime=1000) {

         var html_content='';
        if(icon =='loading')
        {
             html_content = '<div class="la-ball-clip-rotate"><div></div></div>';
        }
        else if(icon==null)
        {
             html_content = '<i class="iconfont icon-check"></i> ';
        }else if(icon!=='text'){
            html_content = '<i class="'+icon+'"></i> ';
        }

        if(icon =='text'){
            $("#yjz-loading-icon1").addClass("yjz-loading-text");
        }else
            $("#yjz-loading-icon1").removeClass("yjz-loading-text");

        if(msg!=='')
            html_content +='<div class="loadingtitle">'+msg+'</div>';

         $("#yjz-loading-icon1").html(html_content);


         $("#yjz-loading-icon1").fadeIn(300);
         if(isfadeout==null || isfadeout==true){
             setTimeout(function () {
                 $("#yjz-loading-icon1").fadeOut(500);
             },lifetime);
         }
         return 'yjz-loading-icon1';
     }


    function show_cart_layer(){
        $('.yjz_cart_mask_layer').show();
        $('.yjz_cart_layer').removeClass("yjz_cart_layer_hide").addClass("yjz_cart_layer_show").show();
        if(!IsPC())
            $('body').css('overflow','hidden');

        $("#cart_p_qty_num").val(1);
    }

    function hide_cart_layer() {
        $('.yjz_cart_mask_layer').delay(400).hide(0);
        // $('.yjz_cart_layer').hide(0);
        $('.yjz_cart_layer,.yjz_mask_layer').removeClass("yjz_cart_layer_show").addClass("yjz_cart_layer_hide");//yjz_cart_layer_hide
        $('.yjz_cart_layer,.yjz_mask_layer').delay(400).hide(0);
        if(!IsPC())
            $('body').css('overflow','');
    }

    function IsPC() {
        var userAgentInfo = navigator.userAgent.toLowerCase();
        var Agents = ["android", "iphone",
            "symbianos", "windows phone",
            "ipad", "ipod","mobile","micromessenger"];
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
            }
        }
        return flag;
    }

    function IsWx() {
        return navigator.userAgent.toLowerCase().indexOf('micromessenger') !== -1
    }

    //选择标签

    function init_product_select_tag() {
        var dls = document.querySelectorAll('.yjz-select-tag dl:not(.select)');
        var selected=document.querySelector('.yjz-select-tag .select');

        for (var i = 0; i < dls.length; i++) {
            dls[i].mark=false;	//给每一行的dl标签添加一条属性，用于对应下面的dd标签。我们约定如果这个属性的值为true表示对应的标签没有创建。如果值为false表示对应的标签已经创建了
            select_yjz_tag(i,dls,selected);
        }

        $(".select_tag_all").click(function(){
            yjzProductBoxInit();
            get_product_data('');

        });

    }

    function select_yjz_tag(n,dls,selected) {
        var dds = dls[n].querySelectorAll('.yjz-select-tag dd ,.yjz-select-tag dl dt ');
        var prev=null;
        var dd=null;	//每一行都需要创建一个dd标签，放到这里是为了如果标签已经被创建了，通过这个变量能够找到这个标签

        for (var i = 0; i < dds.length; i++) {
            dds[i].onclick = function () {

                //清除所有选中的
                $('.yjz-select-tag .select :not(.choose-title)').remove();
                $('.yjz-select-tag dd').removeClass('active');
                $(this).addClass('active');

                var content = $(this).find("span").html();

                if(typeof content == 'undefined')
                    content = $(this).html();

                //   $(selected).append("<dd>"+this.innerHTML+"</dd>");
                dd=document.createElement('dd');
                dd.innerHTML=content;
                selected.appendChild(dd);

                var span=document.createElement('span');
                var This=this;
                span.innerHTML='X';
                span.onclick=function(){

                    $('.yjz-select-tag .select :not(.choose-title)').remove();
                    $('.yjz-select-tag .select').append('<span class="select_tag_all">全部</span>');

                    $('.yjz-select-tag dd').removeClass('active');
                    yjzProductBoxInit();
                    $("#yjz-loading-icon2").show();
                    //  $('.yd-load-product-data-bt').html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>');

                    $(".yjz-pagination ul.page-numbers").html('');
                    get_product_data($("#yjzp_term_ids").val());

                };
                dd.appendChild(span);
                //加载数据
                $("#yjzp_current_page").val(0);
                //  $('.yd-load-product-data-bt').html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>');
                $("#yjz-loading-icon2").show();
                var tagid = $(this).attr("tagid");
                $(".yjz-pagination ul.page-numbers").html('');

                if(typeof $(this).attr("tag_child_id") !== 'undefined')
                {
                    tagid = $(this).attr("tag_child_id");
                }

                get_product_data(tagid);
                //隐藏选择栏
                var is_pc = $(window).width()>1024;
                if(!is_pc)
                {
                    $(".yjzan-widget-yjz-products .yjz-select-tag dl").not(".select").hide();
                    $("#yjz-product-tag-icon").attr('data-statu',0);
                    $("#yjz-product-tag-icon").css('transform','rotate(90deg)');
                }
                //$(".yjzan-widget-yjz-products .select_tag_all").hide();

                product_v_tag_swiper.translate=0; //重置高度
            };
        }
    }//end select_yjz_tag

    //加载数据
    var loading_product_data=0;//正在读取
    var  product_v_tag_swiper;
    var product_h_tag_swiper;
    var product_list_current_tagid = null; //当前标签ID
    var product_list_load_all= 0; //已加载所有数据
    var box_moving = 0;
    var is_back_page =  performance!=undefined && performance.navigation.type==2; // ture is back page!

    if($(".yjzan-widget-yjz-products").length>0)
    {
        $("#yjz-product-ul").css({ 'opacity' : 0 });
        $(".yjz-product-left-box").css({ 'opacity' : 0 });
        $(".yjz-select-tag").css({ 'opacity' : 0 });
        $(".yjz-h-tabs-tag").css({ 'opacity' : 0 });

        setTimeout(product_page_init(),200);
        setTimeout(function () {
            $("#yjz-product-ul").css({ 'opacity' : 1 });
            $(".yjz-product-left-box").css({ 'opacity' : 1 });
            $(".yjz-select-tag").css({ 'opacity' : 1 });
            $(".yjz-h-tabs-tag").css({ 'opacity' : 1 });
        },300);
    }


    //处理产品列表控件
    function product_page_init(){

        if($("#yjzp_term_ids_bak").val()!='')
            product_list_current_tagid = $("#yjzp_term_ids_bak").val();

        //action part 1 移动端 返回产品页面 处理返回页面
        if($(window).width()<=1024 && is_back_page)
        {
            $("#yjz-product-tag-icon").attr('data-statu',0);
            $("#yjz-product-tag-icon").css('transform','rotate(90deg)');
            //主内容
            var content = sessionStorage.getItem('yjz-product-ul-html');
            if(content!='' && content != null)
            {
                $("#yjz-product-ul").html(content);
                imglazyload();
            }


            if($("#open_tag_label").val() == 'tabs')
            {
                //左侧内容
                var left_content = sessionStorage.getItem('yjzp_left_menu_html')
                if(left_content!='' && left_content != null)
                    $(".yjz-product-left-box").html(left_content);

                //顶部内容
                var top_content = sessionStorage.getItem('yjzp_top_menu_html');
                if(top_content!='' && top_content != null)
                    $(".yjz-h-tabs-tag").html(top_content);

            }else if($("#open_tag_label").val() == 'yes')
            {
                var select_tag_html =sessionStorage.getItem('yjzp-select-tag');
                $(".yjz-select-tag").html(select_tag_html)
            }

            $("#yjzp_current_page").val(sessionStorage.getItem('yjzp_current_page'));
            $('.yd-load-product-data-bt').html(sessionStorage.getItem('yjzp-load-product-tip'));
            loading_product_data = sessionStorage.getItem('loading_product_data');

        }else
        {
            sessionStorage.removeItem('yjz-product-ul-html');
            sessionStorage.removeItem('yjzp_left_menu_html');
            sessionStorage.removeItem('yjzp_top_menu_html');
            sessionStorage.removeItem('yjzp-select-tag');
        }

        product_h_tag_swiper = new Swiper('.yjz-h-tabs-tag', {
            direction: 'horizontal',
            slidesPerView: 'auto',
            freeMode: true, //slide会根据惯性滑动可能不止一格且不会贴合。
            on: {
                touchMove: function (event) {
                    event.stopPropagation();
                }, touchEnd: function (event) {
                    event.stopPropagation();
                },//touchEnd
            },//on end...
        });

        product_v_tag_swiper = new Swiper('.yjz-product-left-box', {
            direction: 'vertical',
            slidesPerView: 'auto',
            freeMode: true, //slide会根据惯性滑动可能不止一格且不会贴合。
            on: {
                touchMove: function (event) {
                    event.stopPropagation();
                }, touchEnd: function (event) {
                    event.stopPropagation();
                },//touchEnd
            },//on end...
        });


        var pscontainer = document.getElementById("yjz-product-swp-container");
        var psposition =0;
        pscontainer.addEventListener("touchstart", function(event){
            psposition = $("#yjz-product-swp-container" )[0].scrollTop;
        });
        // pscontainer.addEventListener("touchmove", function(event){
        //    // event.stopPropagation();
        //    // event.preventDefault();
        // });
        pscontainer.addEventListener("touchend", function(event) {

            var psposition2 = $("#yjz-product-swp-container")[0].scrollTop;
            if (psposition2 < psposition) //上滑
            {
                $(".yjz-product-search-wrap").fadeIn(500);
                // $('html,body').animate({ scrollTop: 0 }, 500);

                //$("html" )[0].scrollTop=$(".yjzan-widget-yjz-products" ).offset()+20;;

            }
            else  if (psposition2 > 50)//下滑
            {
                // $(".yjz-product-search-wrap >*").hide();
                $(".yjz-product-search-wrap").fadeOut(500);
            }
        });





        if($("#yjzp_paginate").val()=='1')
        {
            //产品滚动监听事件
            var loading_product_data = 0;
            $("#yjz-product-swp-container").scroll(function(){
                var scrollTop = $("#yjz-product-swp-container" )[0].scrollTop;

                var divHeight = $("#yjz-product-swp-container")[0].clientHeight;
                var scrollHeight  = $("#yjz-product-swp-container")[0].scrollHeight;
                if (scrollTop!=0 && (scrollTop + divHeight  >= scrollHeight)) {
                    $(".yd-load-product-data-bt").html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>   正在加载');
                    var rs = get_product_data(product_list_current_tagid);
                    loading_product_data=1
                    setTimeout(function () {loading_product_data = 0;},2000);
                }
                if(imglazyloading==0)
                {
                    imglazyload();
                    imglazyloading = 1;
                    setTimeout(function () {imglazyloading = 0;},500);
                }

            });
        }

        window.onbeforeunload=function(e){

            sessionStorage.setItem('yjz-product-ul-html',$("#yjz-product-ul").html());
            sessionStorage.setItem('yjzp_main_translate',$("#yjz-product-swp-container" )[0].scrollTop); //高度
            if($("#open_tag_label").val() == 'tabs')
            {
                sessionStorage.setItem('yjzp_left_menu_translate',product_v_tag_swiper.translate); //左侧高度
                sessionStorage.setItem('yjzp_left_menu_html',$(".yjz-product-left-box").html());

                sessionStorage.setItem('yjzp_top_menu_translate',product_h_tag_swiper.translate);//顶部距离
                sessionStorage.setItem('yjzp_top_menu_html',$(".yjz-h-tabs-tag").html());
            }else if($("#open_tag_label").val() == 'yes')
            {
                sessionStorage.setItem('yjzp-select-tag',$(".yjz-select-tag").html());
            }
            sessionStorage.setItem('yjzp_current_page',$("#yjzp_current_page").val());
            sessionStorage.setItem('yjzp-load-product-tip',$('.yd-load-product-data-bt').html());
            sessionStorage.setItem('loading_product_data',loading_product_data);

        }

        if($(window).width()<=1024 && is_back_page )
        {
            var main_translate = sessionStorage.getItem('yjzp_main_translate');

            if(main_translate!='' && main_translate != null)
            {
                $("#yjz-product-swp-container" )[0].scrollTop = main_translate;
            }

            if($("#open_tag_label").val() == 'tabs')
            {
                var left_translate = sessionStorage.getItem('yjzp_left_menu_translate');
                if(left_translate!='' && left_translate != null)
                {
                    product_v_tag_swiper.translate = left_translate;
                    product_v_tag_swiper.update();
                }

                var top_translate = sessionStorage.getItem('yjzp_top_menu_translate');
                if(top_translate!='' && top_translate != null)
                {
                    product_h_tag_swiper.translate = top_translate;
                    // product_h_tag_swiper.update();
                }
            }else if($("#open_tag_label").val() == 'yes')
            {
                var yjzp_select_tag_html =  sessionStorage.getItem('yjzp-select-tag');
                $(".yjz-select-tag").html(yjzp_select_tag_html);
            }

        }else
        {
            sessionStorage.removeItem('yjz-product-ul-html');
            sessionStorage.removeItem('yjzp_top_menu_translate');
            sessionStorage.removeItem('yjzp_main_translate');
            sessionStorage.removeItem('yjzp-select-tag');
        }


        jQuery("#yjz-product-ul").css({ 'opacity' : 1 });
        init_product_select_tag();

        if($(window).width()<=1024)
        {
            $("#yjz-product-tag-icon").attr('data-statu',0);
        }


        $("#yjz-product-tag-icon").on("click", function () {
            if($(this).attr('data-statu')==1)
            {
                $(".yjzan-widget-yjz-products .yjz-select-tag dl").not(".select").hide();
                $(this).attr('data-statu',0);
                $(this).css('transform','rotate(90deg)');
            }else
            {
                $(".yjzan-widget-yjz-products .yjz-select-tag dl").not(".select").show();
                $(this).attr('data-statu',1);
                $(this).css('transform','rotate(270deg)');
            }

        });

        $("#yjz-product-search-txt").on('keypress',function(event){
            if(event.keyCode == 13)
            {
                $("#yjzp_search").val($("#yjz-product-search-txt").val());
                loading_product_data =0;
                $("#yjzp_current_page").val(0);
                get_product_data('');
            }
        });

    }  //init end


    //sessionStorage.clear();
    function get_product_data(tag_id)
    {
        var is_supports = ( 'sessionStorage' in window && window['sessionStorage'] !== null );
        var current_page = typeof $("#yjzp_current_page").val() == 'undefined' ? 1 : parseInt($("#yjzp_current_page").val()) +1;

        if(loading_product_data==1)
        {
            $("#yjz-loading-icon2").hide();
            return ;
        }


        if(product_list_load_all==1 &&tag_id==product_list_current_tagid && $(window).width()<=1024)
        {
            $('.yd-load-product-data-bt').html($("#yjzp_current_page").val()>1?'已经到底了！':'');
            $("#yjz-loading-icon2").hide();
            return ;
        }
        else
            product_list_load_all = 0;


        product_list_current_tagid = tag_id;


        var end_page =  $("#yjzp_end_page").val();
        var page_size =  $("#yjzp_page_size").val();
        var term_ids =  $("#yjzp_term_ids").val();
        var thumb =  $("#yjzp_thumbnail").val();
        var img_size=  $("#yjzp_image_size").val();
        var orderby=  $("#yjzp_orderby").val();
        var search=  $("#yjzp_search").val();
        var featured_id=  $("#yjzp_featured_id").val();
        var variable_id=  $("#yjzp_variable_id").val();

        if(tag_id!=null&&tag_id!='')
        {
            term_ids = tag_id;
        }

        var data_key ='procuct_key_'+current_page+'_'+page_size+'_'+(term_ids==''?'all':term_ids)+'_'+thumb+'_'+img_size+'_'+search;

        if(is_supports && sessionStorage.getItem(data_key)!=null)
        {
            var rps_cache = JSON.parse(sessionStorage.getItem(data_key));
            yjz_load_product_data(rps_cache);
            loading_product_data=0;
            $("#yjz-loading-icon2").hide();
            return;
        }

        var params = {'action':'yjz_get_products','page':current_page,'page_size':page_size,'term_ids':term_ids,'thumb':thumb,'img_size':img_size,'orderby':orderby,'search':search,'featuredid':featured_id,'variableid':variable_id};

        if(current_page>end_page)
        {
            loading_product_data=0;
            if($(window).width()<=1024)
            {
                $('.yd-load-product-data-bt').html($("#yjzp_current_page").val()>1?'已经到底了！':'');
                product_list_load_all=1;
            }


            $("#yjz-loading-icon2").hide();
            return;
        }else
        {
            if($(window).width()>1024)
            {
                // $('.yd-load-product-data-bt').css('visibility','initial');
                $("#yjz-loading-icon2").show();
            }
            else if(current_page>1)
                $('.yd-load-product-data-bt').html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>   正在加载');
        }

        loading_product_data=1;
        $.ajax({
            type   : 'POST',
            url    : site_url+ "/wp-admin/admin-ajax.php",
            dataType: "JSON",
            data   : params,
            success: function (req) {
                yjz_load_product_data(req);
                loading_product_data=0;
                if(is_supports && req.status!=0 )
                    sessionStorage.setItem(data_key, JSON.stringify(req));

                $("#yjz-loading-icon2").hide();
            },
            error  : function (data) {
                loading_product_data=0;
                if($(window).width()>1024)
                    $('.yd-load-product-data-bt').css('visibility','hidden');

                $("#yjz-loading-icon2").hide();
            },
        });
    }

    function yjz_load_product_data(req)
    {
        if($(window).width()>1024)
            $('.yd-load-product-data-bt').css('visibility','hidden');

        if(req.status==0)
        {
            yjzWinInfo('加载数据失败','text');
            $(".yd-load-product-data-bt").html('');
            return;
        }
        else if(req.status==2){

            $('.yd-load-product-data-bt').html($("#yjzp_current_page").val()>1?'已经到底了！':'');
            product_list_load_all==1;
            return;
        } else if(req.status==3)
        {
            $("#yjz-product-ul").html('<div class="not-found-any-thing"><h5>暂未查找到任何产品</h5><img src="https://cdn.jsdelivr.net/npm/yjzan2020/other/img/cart_empty.png" ></div>');
            product_list_load_all==1;
            $(".yd-load-product-data-bt").html('');

            return;
        }

        if(req.data!='')
        {
            if($(window).width()>1024)
            {
                $("#yjz-product-ul").html(req.data);
                //更新页码
                updatePageNumber(req.page_total,req.page);
            }
            else if(req.page<=1)
                $("#yjz-product-ul").html(req.data);
            else
                $("#yjz-product-ul").append(req.data);

            imglazyload();

            $("#yjzp_current_page").val(req.page)
            $("#yjzp_end_page").val(req.page_total)

            $(".add_to_cart_button").not(".finish").on("click", function (event) {
                event.stopPropagation();
                if($(this).hasClass("disabled"))
                {
                    yjzWinInfo('该产品已售空','text');
                    return ;
                }
                return product_add_to_cart(this);
            });

        }

        if($(window).width()<=1024)
            $('.yd-load-product-data-bt').html('');

    }


    function updatePageNumber(endPage,c_page)
    {
        if(endPage==1)
        {
            $(".yjz-pagination ul.page-numbers").html("");
            return;
        }

        var list_size = parseInt($("#yjzp_per_page_num").val());
        var c_list_size = parseInt($("#yjzp_c_page_num").val());//当前列表
        c_page = parseInt(c_page);

        if( typeof  list_size == "undefined" )
            return;

        var c_page = c_page>endPage ? endPage:c_page; //当前页比总页数大时候等于最后一页
        var n_size = Math.floor(c_page/list_size)*list_size;
        var n_size_s = n_size==0 ? 1: n_size;
        var n_size_e = n_size + list_size;
        n_size_e = n_size_e > endPage ? endPage: n_size_e;
        var html = '';

        var prev_page = c_page-1<1 ? 1:c_page-1;
        html = '<li><a class="prev page-numbers" href="javascript:void(0);" data-id="" data-page="'+prev_page+'" title="上一页"><</a></li>';
        for(var i = n_size_s; i <= n_size_e;i++)
        {
            var is_current_page = i == c_page ? 'current':'';
            html +='<li><a class="page-numbers '+is_current_page+'" href="javascript:void(0);" data-id="" data-page="'+i+'" >'+i+'</a></li>';
        }

        var next_page = c_page+1 > endPage ? endPage:c_page+1;
        html +='<li><a class="next page-numbers" href="javascript:void(0);" data-id="" data-page="'+next_page+'" title="下一页" >></a></li>';

        $(".yjz-pagination ul.page-numbers").html(html);

        initYjzPageNumber();
    }

    function initYjzPageNumber()
    {
        $(".yjz-pagination a.page-numbers").on("click", function (event) {
            if($(this).hasClass("current"))
                return;

            event.stopPropagation();
            $(".yjz-pagination a.page-numbers").removeClass("current");

            var c_page = parseInt($(this).attr('data-page'));
            $(".yjz-pagination a.page-numbers").not(".prev, .next").each(function(){
                if($(this).attr('data-page')==c_page)
                {
                    $(this).addClass("current");
                }
            });

            var page = c_page-1 ;
            $("#yjzp_current_page").val(page);
            var rs = get_product_data(product_list_current_tagid);

        });
    }

    initYjzPageNumber();


    function yjzProductBoxInit()
    {
        $("#yjzp_current_page").val(0);
        $('#yjz-product-ul').html('');
        $(".yjz-pagination ul.page-numbers").html('');
        $('#yjzp_search').val('');
        $('.yjzan-search-form__input').val('');
        $("#yjz-loading-icon2").show();
        $(".yd-load-product-data-bt").html('');
        product_list_load_all = 0;
    }

    //产品tabs 竖型标签点击
    $(".yjz-product-left-box .p-child-tag").on("click",function(){
        yjzProductBoxInit();
        get_product_data($(this).attr("tagid"));
        $(".yjz-product-left-box .p-child-tag.active").removeClass("active");
        $(this).addClass("active");
    });

    //产品tabs 水平标签点击
    $(".yjz-h-tabs-tag .swiper-slide span").on("click",function () {
        $(".yjz-h-tabs-tag .swiper-slide.active").removeClass("active");
        $(".yjz-product-left-box .p-child-tag.active").removeClass("active");
        $(this).parent().addClass("active");
        yjzProductBoxInit();
        if($(this).attr("tagid")=='all' || typeof  $(this).attr("tagid") == 'undefined')
        {
            $(".yjz-product-left-box .p-child-tag").show();
            //加载全数据
            get_product_data($("#yjzp_term_ids").val());
        }else
        {
            var parent_class_id = '.tag-parent-'+ $(this).attr("tagid");
            $(".yjz-product-left-box .p-child-tag").not(parent_class_id).hide();
            $(".yjz-product-left-box .p-child-tag"+ parent_class_id).show();

            //加载分类目录数据
            get_product_data($(this).attr("tag_child_id"));
        }
        product_v_tag_swiper.translate=0;
        product_v_tag_swiper.update();
    });


    $(".yjz-select-tag dl dt").on("click",function () {
        yjzProductBoxInit();
        var ids = $(this).attr("tag_child_id");
        get_product_data(ids);
    });

    $("#return_btn_product").on("click",function () {
        $(".yjz_product_detail").hide();
        quantity();
    });



     var  imglazyloading = 0 ;
    // window.onscroll = function() {
    //     console.log(1);
    //     if(imglazyloading==0)
    //     {
    //         console.log(2);
    //         imglazyload();
    //         imglazyloading = 1;
    //         setTimeout(function () {imglazyloading = 0;},800);
    //     }
    // };

    if(typeof(yjzan_data )!== 'undefined' &&typeof(yjzan_data.isEditModel )!== 'undefined' && yjzan_data.isEditModel =='true')
    {
        var loadlazypic = setInterval(function () {
            $('img.lazy:not(".imgfinish")').each(function () {
                var url = $(this).attr('data-original');
                $(this).attr('src',url);
                $(this).addClass('imgfinish');
            });
        }, 1000);
    }

   setTimeout(function(){imglazyload();},300);


    function imglazyload() {
        var v_threshold = $(window).width()>1024 ? 300 : 100;
        $('img[data-original]:not(".imgfinish")').unbind();
        $('img[data-original]:not(".imgfinish")').lazyload({
            //   container: $('.yjz-piclib-box'),
            threshold: v_threshold,                    //当图片顶部距离显示区域还有100像素时，就开始加载
            placeholder : yjzan_data.lazyimg ,      // 图片未加载时，占位
            effect: "fadeIn",               // 图片出现的效果，值有show(直接显示),fadeIn(淡入),slideDown(下拉)
            effect_speed: 100,                // 效果出现的时间
            event: 'scroll',                   // 滚动滚轮时触发，可以是：click、mouseover等
            data_attribute: 'original',        // img标签中保存url的自定义属性，默认：data-original
            //    skip_invisible: false,              // 是否跳过已经隐藏的图片（display:none）
            failure_limit: 10,                  // 由于延迟加载是根据Dom从上到下执行
            // appear: function(){                // 当图片位置刚出现在视图时，触发此事件
            //     $(this).addClass('imgfinish');
            // },
            load: function(){                  // 当图片路径加载之后，触发此事件
                $(this).addClass('imgfinish');
            }
        });

    }

    // begin 微信分享function

    function wx_share_init(imgbase64,wxpicobj) {
        var sharePicUrl = imgbase64;
        var qrcodeUrl =   $(wxpicobj).siblings(".yjz-wx-share-data").attr("data-qrcodr");
        var headImgUrl =  $(wxpicobj).siblings(".yjz-wx-share-data").attr("data-userhead");
        var nickname =   $(wxpicobj).siblings(".yjz-wx-share-data").attr("data-nickname");
        var postTitle =  $(wxpicobj).siblings(".yjz-wx-share-data").attr("data-post-title");
        // var postDesc =  $(wxpicobj).siblings(".yjz-wx-share-data").attr("data-post-desc");
        var face_finish = 0;
        var canvas = document.createElement('CANVAS'),
            ctx = canvas.getContext('2d'),
            post_img = new Image,
            head_img = new Image;


        $('.share-pic-view-warp .wxname').text(nickname);
        $('.share-pic-view-warp .share-title').text(postTitle);
        // $('.share-pic-view-warp .share-dsc').text(postDesc);

        if($('.share-pic-view-warp #share-qrcode').html()=='')
        {
            $('.share-pic-view-warp #share-qrcode').qrcode({
                render: "canvas",
                width: 60,
                height: 60,
                text: qrcodeUrl
            });
        }

        //加载头像
        if(headImgUrl=='')
        {

            $(".share-pic-view-warp #wx_head_img").hide();
            $(".share-pic-view-warp .pyqicon").show();
            face_finish =1;
        }else
        {
            head_img.crossOrigin = 'Anonymous';
            head_img.onload = function(){
                canvas.height = head_img.height;
                canvas.width = head_img.width;
                ctx.drawImage(head_img,0,0);
                var dataURL = canvas.toDataURL('image/png');
                $("#wx_head_img").attr('src',dataURL);
                face_finish =1;
            };
            head_img.src = headImgUrl;
        }

        //加载主图
        post_img.crossOrigin = 'Anonymous';
        post_img.onload = function(){
            canvas.height = post_img.height;
            canvas.width = post_img.width;
            ctx.drawImage(post_img,0,0);
            var dataURL = canvas.toDataURL('image/png');
            $("#yjz_post_thumbnail").attr('src',dataURL);
            if(face_finish==0)
                create_share_img();
            else
                setTimeout(create_share_img(),1000);

        };
        post_img.src = sharePicUrl;
    }


    function get_share_price() {
        if($("#price-panel ins").length!=0)
        {
            $(".share-pic-view #salesPriceText").html($("#price-panel ins").html());

            if($("#price-panel .salse-price-tag").length!=0)
                $(".share-pic-view #originPriceText").html($("#price-panel .salse-price-tag").html());

        }else if($("#price-panel .price-range").length!=0)
        {
            var pricerange = $("#price-panel .price-range").html();
            $(".share-pic-view #salesPriceText").html(pricerange);
        }

        if(typeof $("#price-panel").attr('timesstamp') != 'undefined'){
            console.log('限时折扣')
        }

    }

    $(".cmd-wx-pic").click(function(){
        get_share_price();

        $("#share-pic-view").hide();
        $("#share-pic-view-warp").css('display','flex');
        if($("#share-pic").attr("data-finish")==1)
        {
            $(".loader-icon-wrap").hide();
            $("#share-pic").show();
            return ;
        }

        $(".loader-icon-wrap").show();
        $("#share-pic").show();

        var imgurl = $(this).siblings(".yjz-wx-share-data").attr("data-thumbnail");
        var wxpicobj = $(this);

        //imgurl  var shareimg = data.imgdata;
        wx_share_init(imgurl,wxpicobj);

    });

    function  create_share_img() {

        var isAndroid = navigator.userAgent.indexOf('Android') > -1 || navigator.userAgent.indexOf('Adr') > -1; //android终端
        var isiOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        var is_pc = $(window).width()>1024;
        var is_wx = navigator.userAgent.toLowerCase().indexOf('micromessenger') !== -1;
        var is_qqb = navigator.userAgent.toLowerCase().indexOf('mqqbrowser') !== -1;

        if(isiOS)
        {
            window.pageYOffset = -10;
            document.documentElement.scrollTop = -10;
            document.body.scrollTop = -10;
        }else if(!is_wx && is_qqb){
            window.pageYOffset = 25;
            document.documentElement.scrollTop = 25;
            document.body.scrollTop = 25;
        }else if(!is_wx){
            window.pageYOffset = -10;
            document.documentElement.scrollTop = -10;
            document.body.scrollTop = -10;
        }
        else if(is_wx){
            window.pageYOffset = 0;
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
        }

        $("#share-pic").hide();

        $(".loader-icon-wrap").show();
        $("#share-pic-view").show();

        var opts = {useCORS:true, allowTaint: true}; //,logging:false
        html2canvas(document.querySelector("#share-pic-view"), opts).then(function(canvas){
           // $("#share-pic").hide();
            $(".loader-icon-wrap").hide();
            $("#share-pic").attr("src",canvas.toDataURL("image/jpeg"));
            $("#share-pic").load(function(){$(".loader-icon-wrap").hide(); $("#share-pic-view").hide(); $("#share-pic").show();});
            $("#share-pic").attr("data-finish",1);
        });

    }

    $(".share-pic").click(function(event){
        event.stopPropagation();
    });

    //图片加载事件
    function loadImage(url, callback) {
        var img = new Image();
        img.src = url;
        if(img.complete) { // 如果图片已经存在于浏览器缓存，直接调用回调函数
            callback.call(img);
            return;
        }
        img.onload = function () {
            callback.call(img);//将回调函数的this替换为Image对象
        };
    };

    $(".cmd-douban").click(function(){
        var url ="https://www.douban.com/share/service?href="+window.location.href+"&name="+document.title+'&text=这个内容很有趣哦';
        window.open(url);
    });

    $(".cmd-tsina").click(function(){
        var url ="https://service.weibo.com/share/share.php?url="+window.location.href+"&title="+document.title;
        window.open(url);
    });

    $(".cmd-sqq").click(function(){
        var url ="https://connect.qq.com/widget/shareqq/index.html?url="+window.location.href+"&title="+document.title+"&desc=这个内容很有趣哦";
        window.open(url);
    });

    $(".cmd-qzone").click(function(){
        //&title=新鲜广东牛肉 – 易极赞自助建站平台&desc=
        var url ="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url="+window.location.href+"&title="+document.title+"&desc=这个内容很有趣哦";
        window.open(url);
    });

    $(".cmd-weixin").click(function(){
        if(IsWx()){
            $(".share-pic-view-warp2").show();
        }
        else
        {
            $(".yjz-share-qcode").not(".finish").attr('src','/qrcode-output.php?url='+window.location.href);
            setTimeout(function () {
               $(".yjz-share-qcode").addClass('finish');
            },1000);
            $('.wx-share-pc-qcode').show();
        }
    });

    $(".cmd-copy-url").click(function(){
      // var clipBoardContent = location.href;
        //window.clipboardData.setData("Text",clipBoardContent);
        yjzWinInfo('复制成功');

    });

    new ClipboardJS('.copybtn');

    $(".bd_weixin_popup_close").click(function(){
        $('.wx-share-pc-qcode').hide();
    });

    // end 微信分享function

    setTimeout( initBtn, 2000 );
    function initBtn()
    {
        $(".yjzan-button--checkout").not(".yjzUserNotLogin").unbind();
        $(".yjzan-button--checkout").not(".yjzUserNotLogin").click(function(){
            var is_pc = $(window).width()>1024;
            if($(this).hasClass("not-login-usr")){ //未登录
                if(IsWx())
                {
                    yjzWinInfo('登录账号','text');
                    location.href='/cart/';
                }
                else
                {
                    yjzWinInfo('账号尚未登录','text');
                    location.href='/wp-login.php?redirect_to=/cart/';
                }
            }
            else{
                location.href='/checkout/';
            }

        });

        $(".remove-cart-item").unbind();
        $(".remove-cart-item").on("click", function () {
            setCartItemQuantity(this,0);
        });

    }//initBtn


    // //不是返回页面
    // if($(window).width() < 1024)
    // {
    //     if(!is_back_page)
    //         setTimeout( function(){$("#yjz-loading-icon2").show();}, 200 );
    //     setTimeout( function(){$("#yjz-loading-icon2").hide();}, 4000 );
    // }


    $(".woo-mobile-navigation , .yjz-h-tabs-tag ,.yjzan-search-form__input").on("touchmove", function(e){
        e.preventDefault();
    });


    //pc商城分类组件
    $(".scbtnicon").click(function(e){
        if($(this).siblings(".scbul_warp .yjz_scbtn_ul").is(":hidden"))
        {
            $(this).siblings(".scbul_warp .yjz_scbtn_ul").show();
        }else
        {
            $(this).siblings(".scbul_warp  .yjz_scbtn_ul").hide();
        }
    });

//遍历组件

    $(".yjzan-widget-woocommerce-product-price").each(function () {
        var timesstamp = $(this).find(".sale-date-panel").attr("timesstamp");
        if(typeof  timesstamp !== 'undefined')
        {
            var sale_timesstamp = new Date(timesstamp).getTime();
            TimeDown($(this),sale_timesstamp,0);
        }

        //分享按钮
        $(this).find(".share-icon").click(function(){
            $('.yjz_cart_mask_layer').show();
            $('.sharegroup').removeClass("yjz_cart_layer_hide").addClass("yjz_cart_layer_show").css('display','flex');
        });

        //取消
        $(this).find(".share_footer_btn,.yjzan-icon-warp,.desc-panle,.group_footer_btn").not(".qrfootbtn").click(function(){
            $('.yjz_cart_mask_layer').hide();
            $('.sharegroup').hide();
            $('.sharegroup').removeClass("yjz_cart_layer_show");

            $('.descgroup').removeClass("yjz_cart_layer_show").addClass('yjz_cart_layer_hide');
            $('.descgroup').fadeOut(300);
        });



        //产品描述
        $(this).find(".desc-panle").click(function(){
            $('.yjz_cart_mask_layer').show();
            $('.descgroup').removeClass("yjz_cart_layer_hide").addClass("yjz_cart_layer_show").css('display','flex');
        });

        //关注公众号
        $(this).find(".btn-group .gzdp_btn ").click(function(){
            $('.yjz_cart_mask_layer').show();
            $('.QRCodeGroup').removeClass("yjz_cart_layer_hide").addClass("yjz_cart_layer_show").css('display','flex');
        });
        $(this).find(" .qrfootbtn .cancel_btn").click(function(){
            $('.yjz_cart_mask_layer').hide();
            $('.QRCodeGroup').removeClass("yjz_cart_layer_show").addClass('yjz_cart_layer_hide');
            $('.QRCodeGroup').fadeOut(300);
        });

        $(this).find(".QRCodeGroup .copy_btn").click(function(){
            yjzWinInfo('复制成功');

            // $('.yjz_cart_mask_layer').hide();
            // $('.QRCodeGroup').removeClass("yjz_cart_layer_show").addClass('yjz_cart_layer_hide');
            // $('.QRCodeGroup').fadeOut(300);
        });




    });

    function TimeDown(obj, endDateStr,ms) {

        var endDate = new Date(endDateStr);
        var nowDate = new Date();
        var totalSeconds = parseInt((endDate - nowDate) / 1000);
        var days = Math.floor(totalSeconds / (60 * 60 * 24));
        var modulo = totalSeconds % (60 * 60 * 24);
        var hours = Math.floor(modulo / (60 * 60));
        modulo = modulo % (60 * 60);
        var minutes = Math.floor(modulo / 60);
        var seconds = modulo % 60;
        if(days==0){
                $(obj).find('.yjzan-countdown-item.p-days').hide();
            }
        $(obj).find(".yjzan-countdown-days").html(days<10?'0'+days:days);
        $(obj).find(".yjzan-countdown-hours").html(hours<10?'0'+hours:hours);
        $(obj).find(".yjzan-countdown-minutes").html(minutes<10?'0'+minutes:minutes);
        $(obj).find(".yjzan-countdown-seconds").html(seconds<10?'0'+seconds:seconds);

        // ms= ms%60;
        // $(obj).find(".yjzan-countdown-m-seconds").html(ms<10?'0'+ms:ms);
        ms+=2;
        setTimeout(function () { TimeDown(obj, endDateStr,ms);}, 34);
    }
    //end 价格组件

//end 遍历组件

    /**this is end**/
})( jQuery );




//点击组合标签显示组合标签对应的价钱 ,和图片
function  yjz_choose_cart_var(obj,is_detail_page=false) {
    var $ = jQuery;

    if($(obj).hasClass('out_of_stock'))
    {
        return false;
    }

    //取消激活
    if($(obj).hasClass('cart_labelacive'))
    {
        $(obj).removeClass('cart_labelacive');

        if($(obj).attr('data-img') !='')
            $("#yjz_cart_p_img").attr("src",$("#yjz_cart_p_img").attr('data-original'));

    }else
    {
        var data_group= '.'+$(obj).attr('data-group');
        $('.yjz_cart_choose_value'+data_group).removeClass('cart_labelacive');
        $(obj).addClass('cart_labelacive');

        //替换图片
        if($(obj).attr('data-img') !='')
            $("#yjz_cart_p_img").attr("src",$(obj).attr('data-img'));
    }

    //详情页
    // if(is_detail_page &&  typeof $('.cart_p_info').attr('data-pinfo') == 'undefined')
    // {
    //    var data_pinfo =  $(".pc_yjz_cart_layer").attr('data-pinfo');
    //     $('.p_attr_json').attr('data-pinfo',data_pinfo);
    // }

    //选项提示信息
    print_cart_p_tip();
    print_cart_p_price();
    check_out_of_stock_product();
}

function print_cart_p_price()
{
    var $ = jQuery;
    var res = JSON.parse($('.p_attr_json').attr('data-pinfo'));
    var price = '';
    var current_attr = get_choose_attr();
    var p_currency = $('#cart_p_price').attr('data-currency');
    if(current_attr == false)
    {
        $('#cart_p_price').html($('#cart_p_price').attr('data-pricetext'));
    }else
    {
        if ( typeof  current_attr['_sale_price'] === 'undefined' || current_attr['_sale_price']==''||current_attr['is_on_sale']=='0')
        {
            price = '<span class="price">'+
                '<span class="p_currency">'+p_currency+'</span>'+ parseFloat( current_attr['_regular_price']).toFixed(2)+ '</span>' ;
        }else
        {
                price = '<span class="price">'
                    +'<span class="p_currency">'+p_currency+'</span>'+  parseFloat( current_attr['_sale_price']).toFixed(2)
                    +'<del>原价 : <span class="p_currency">'+p_currency+'</span>'+ parseFloat( current_attr['_regular_price']).toFixed(2) +'</del>'
                    + '<span class="discount_tag">限时折扣</span>'
                    + '</span>' ;
        }
        $('#cart_p_price').html(price);
    }
}

function get_choose_attr() {
    var $ = jQuery;
    var res = JSON.parse($('.p_attr_json').attr('data-pinfo'));
    var price = '';

    if($('.cart_labelacive').length != res.options_length)
        return false;

    var target_attr = false;
    var has_free_options = false;
    for(var key in res.attrdata)
    {
        var item = res.attrdata[key];
        var is_target = true;
        $('.yjz_cart_choose_value.cart_labelacive').each(function()
        {
            if(typeof item[$(this).attr('data-key')] == 'undefined')
            {
                is_target = is_target && true;
                has_free_options = true;
            }
            else if (item[$(this).attr('data-key')] == $(this).attr('data-value'))
                is_target = is_target && true;
            else
                is_target = false;
        });

        if(is_target==true)
        {
            target_attr = res.attrdata[key];
            target_attr.attrid=key;
            break;
        }
    }


    if(has_free_options)
    {
        $('.yjz_cart_choose_value.cart_labelacive').each(function(){
            if(typeof target_attr[$(this).attr('data-key')] == 'undefined')
            {
                target_attr[$(this).attr('data-key')] = $(this).attr('data-value');
            }

        });
    }

    return target_attr;
}


//更改提示
function print_cart_p_tip()
{
    var $ = jQuery;
    var res = JSON.parse($('.p_attr_json').attr('data-pinfo'));
    var tip ='';
    //全部勾选
    if($('.cart_labelacive').length == res.options_length)
    {
        $('.yjz_cart_choose_value.cart_labelacive').each(function()
        {
            tip += tip==''? $(this).attr('data-value') : " ; "+$(this).attr('data-value');
        });
        tip ='已选择 ' + tip;
    }else
    {

        for(var key in res.options)
        {
            var is_exsit = false;
            $('.yjz_cart_choose_value.cart_labelacive').each(function()
            {
               if($(this).attr('data-key') == key)  is_exsit =true;
            });

            if(!is_exsit)
                tip += tip==''? key : " ; "+key;
        }

        tip ='请选择 ' + tip;
    }

    $('.cart_p_tip').html(tip);
}

//标记缺货产品
function check_out_of_stock_product() {
    var $ = jQuery;
    var res = JSON.parse($('.p_attr_json').attr('data-pinfo'));

    //缺货对象
    var temp_p = new Array();
    for(var key in res.attrdata)
    {
        if(res.attrdata[key]['_stock_status']=='outofstock')
            temp_p.push(res.attrdata[key]);
    }

    if(temp_p.length==0)
        return false;

    //选项
    var option_group = new Array();
    for(var key in res.options)
        option_group.push(key);

    //当前激活项//
    var choose_item = new Array();
    $('.yjz_cart_choose_value.cart_labelacive').each(function()
    {
        var option_name = $(this).attr('data-key');
        var option_value = $(this).attr('data-value');
        choose_item.push({'key':option_name,'value':option_value})
    });

    //初始化
    $('.yjz_cart_choose_value').each(function()
    {
            $(this).removeClass('out_of_stock');
    });

    var i,i1,i2;

    for( i = 0;i<temp_p.length;i++)
    {
        var outp = temp_p[i];
        for( i1 = 0;i1<choose_item.length;i1++)
        {
           var option_name = choose_item[i1]['key'];
            if(choose_item[i1]['value'] == outp[option_name])
            {
                for( i2 = 0;i2<option_group.length;i2++)
                {
                    if(option_group[i2]== option_name)
                        continue;

                    //屏蔽其他可选项目
                    $('.yjz_cart_choose_value').each(function()
                    {
                        var other_option_name = option_group[i2];
                        if($(this).attr('data-key')==other_option_name && outp[other_option_name] ==$(this).attr('data-value'))
                        {
                            $(this).addClass('out_of_stock');
                        }
                    });
                }//option_group
            }
        }//choose_item
    } //temp_p

}//check_out_of_stock_product

//'我的{0}是{1}'.format('id','城市之光');我的{name1}是{name2}'.format({name1:'id',name2:'城市之光'})
String.prototype.format = function(){
    if(arguments.length==0){
        return this;
    }
    for(var s=this, i=0; i<arguments.length; i++){
        s = s.replace(new RegExp("\\{"+i+"\\}","g"), arguments[i]);
    }
    return s;
};String.prototype.format = function(){
    if(arguments.length==0){
        return this;
    }
    for(var s=this, i=0; i<arguments.length; i++){
        s = s.replace(new RegExp("\\{"+i+"\\}","g"), arguments[i]);
    }
    return s;
};
